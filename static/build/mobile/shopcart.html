<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no,target-densitydpi=medium-dpi">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<script type="text/javascript" src="/fishstrap/lib/mod.js"></script>
	<title>购物车页面</title>
<link rel="stylesheet" type="text/css" href="/mobile/common/core/core_8488e02.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/dialog/dialog_09f6162.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/header/header_b51a32c.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/headertitle/headertitle_aca84ff.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/itemlistwithnum/itemlistwithnum_b80b523.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/numchooser/numchooser_c64b34c.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/itembrief/itembrief_bc23208.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/footerbutton/footerbutton_eea48c6.css">

<script type="text/javascript" src="/fishstrap/lib/fastclick.js"></script>
<script type="text/javascript" src="http://apps.bdimg.com/libs/underscore.js/1.7.0/underscore-min.js"></script>
<script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript" src="/fishstrap/core/global_0ffe271.js"></script>
<script type="text/javascript" src="/mobile/common/dialog/dialog_5a39b67.js"></script>
<script type="text/javascript" src="/mobile/common/core/core_ced14df.js"></script>
<script type="text/javascript" src="/mobile/common/header/header_23de960.js"></script>
<script type="text/javascript" src="/mobile/common/headertitle/headertitle_9a8434f.js"></script>
<script type="text/javascript" src="/mobile/common/numchooser/numchooser_faad02f.js"></script>
<script type="text/javascript" src="/mobile/common/itembrief/itembrief_bf37e55.js"></script>
<script type="text/javascript" src="/mobile/common/itemlistwithnum/itemlistwithnum_0a8800b.js"></script>
<script type="text/javascript" src="/fishstrap/util/uedit_466b933.js"></script>
<script type="text/javascript" src="/mobile/common/footerbutton/footerbutton_7c867f1.js"></script>

</head>
<body>
	<div id="body"></div>
	<script type="text/javascript">
		var $ = require('mobile/common/core/core.js');
		var dialog = require('mobile/common/dialog/dialog.js');
		var Header = require('mobile/common/header/header.js');
		var HeaderTitle = require('mobile/common/headertitle/headertitle.js');
		var ItemListWithNum = require('mobile/common/itemlistwithnum/itemlistwithnum.js');
		var FooterButton = require('mobile/common/footerbutton/footerbutton.js');
		var shopcart = {};
		function getShopCart(next){
			$.get('/troller/get',{},function(data){
				if(data.code != 0 ){
					dialog.message(data.msg);
					return;
				}
				shopcart = data.data;
				next();
			});
		}
		function go(){
			var header = new Header({
				title:'购物车',
				backLink:'item.html',
				button:[{
					name:'search',
					link:'search.html'
				}]
			});
			var headertitle = new HeaderTitle({
				tip:'订单总金额：',
				text:'0元'
			});
			var itemlistwithnum = new ItemListWithNum({
				title:'店铺',
				item:_.map(shopcart,function(single){
					return {
						shopTrollerId:single.shopTrollerId,
						shopCommodityId:single.shopCommodityId,
						image:single.icon,
						title:single.title,
						summary:single.introduction,
						price:single.price,
						stock:single.inventory,
						quantity:single.quantity,
					};
				}),
				change:whenItemListChange
			});
			function refreshHeaderTitle(){
				var checkedItemList = itemlistwithnum.getChecked();
				var orderPrice = 0;
				for( var i in checkedItemList ){
					orderPrice += checkedItemList[i].price * checkedItemList[i].quantity;
				}
				headertitle.set({text:orderPrice+'元'});
			}
			function refreshShopCart(next){
				var allItemList = itemlistwithnum.getAll();	
				var shopCommodity = _.map(allItemList,function(single){
					return {shopCommodityId:single.shopCommodityId,quantity:single.quantity};
				});
				$.post('/troller/set',{shopCommodity:shopCommodity},function(data){
					if( data.code != 0 ){
						dialog.message(data.msg);
						return;
					}
					next(data.data);
				});
			}
			function goShopCart(next){
				refreshShopCart(function(isStockChange){
					if( isStockChange == true ){
						dialog.message('库存有限，请重新选择商品数量',function(){
							location.reload();
						});
					}else{
						next();
					}
				});
			}
			function goAddress(){
				var checkedItemList = itemlistwithnum.getChecked();
				var shopTroller  = '';
				for( var i in checkedItemList ){
					if( shopTroller != '')
						shopTroller += '|';
					shopTroller += checkedItemList[i].shopTrollerId;
				}
				if( shopTroller == ''){
					dialog.message('请选择要结算的商品');
				}else{
					location.href = $.url.buildQueryUrl('address.html',{shopTroller:shopTroller});
				}
			}
			function whenItemListChange(){
				refreshHeaderTitle();
				refreshShopCart(_.noop);
			}
			var footerbutton = new FooterButton([
				{
					name:'pay',
					text:'结算',
					click:function(){
						goShopCart(goAddress);
					}
				}
			]);
			var pageHtml = header.el + headertitle.el + itemlistwithnum.el+footerbutton.el;
			$.page.setGrey();
			$.page.start(pageHtml);
		}
		$.checkMustLogin(function(){
			getShopCart(go);
		});
	</script>
</body>
</html>