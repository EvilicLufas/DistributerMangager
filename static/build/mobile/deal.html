<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no,target-densitydpi=medium-dpi">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<script type="text/javascript" src="/fishstrap/lib/mod.js"></script>
	<title>订单页面</title>
<link rel="stylesheet" type="text/css" href="/mobile/common/core/core_8488e02.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/dialog/dialog_09f6162.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/footer/footer_442a17a.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/headerbutton/headerbutton_1f1e145.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/deallist/deallist_976ebb1.css">

<script type="text/javascript" src="/fishstrap/lib/fastclick.js"></script>
<script type="text/javascript" src="http://apps.bdimg.com/libs/underscore.js/1.7.0/underscore-min.js"></script>
<script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript" src="/fishstrap/core/global_0ffe271.js"></script>
<script type="text/javascript" src="/mobile/common/dialog/dialog_e661e90.js"></script>
<script type="text/javascript" src="/mobile/common/core/core_ced14df.js"></script>
<script type="text/javascript" src="/mobile/common/footer/footer_b27c0d4.js"></script>
<script type="text/javascript" src="/mobile/common/headerbutton/headerbutton_8397b60.js"></script>
<script type="text/javascript" src="/mobile/common/deallist/deallist_702040d.js"></script>

</head>
<body>
	<div id="body"></div>
	<script type="text/javascript">
		var $ = require('mobile/common/core/core.js');
		var dialog = require('mobile/common/dialog/dialog.js');
		var Footer = require('mobile/common/footer/footer.js');
		var HeaderButton = require('mobile/common/headerbutton/headerbutton.js');
		var DealList = require('mobile/common/deallist/deallist.js');
		var state = $.location.getQueryArgv('state');
		var orderStateIdToName = {0:'全部',1:'未支付',2:'待发货',3:'已发货'};
		var orderStateList = [0,1,2,3];
		var orderCount = {};
		var orderList = [];
		var orderState = (state == null)?0:state;
		function getOrderCount(next){
			$.get('/deal/getMyOrderCount',{},function(data){
				if( data.code != 0 ){
					dialog.message(data.msg);
					return;
				}
				orderCount = data.data;
				next();
			});
		}
		function getOrderList(next){
			$.get('/deal/getMyOrderList',{state:orderState},function(data){
				if( data.code != 0 ){
					dialog.message(data.msg);
					return;
				}
				orderList = data.data;
				next();
			});
		}
		function go(){
			var footer = new Footer('deal');
			var headerbutton = new HeaderButton(_.map(orderStateList,function(key){
				return {
					name:orderStateIdToName[key],
					number:orderCount[key],
					click:function(){
						location.href = 'deal.html?state='+key;
					}
				};	
			}));
			var deallist = new DealList(_.map(orderList,function(single){
				return {
					image:single.image,
					id:single.shopOrderId,
					state:orderStateIdToName[single.state],
					price:single.priceShow,
					link:$.url.buildQueryUrl('dealdetail.html',{shopOrderId:single.shopOrderId})
				};
			}));
			var pageHtml = headerbutton.el + deallist.el + footer.el;
			$.page.setGrey();
			$.page.start(pageHtml);
		}
		getOrderCount(function(){
			getOrderList(go);
		});
	</script>
</body>
</html>