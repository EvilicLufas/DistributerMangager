<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no,target-densitydpi=medium-dpi">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<script type="text/javascript" src="/fishstrap/lib/mod.js"></script>
	<title>购物车页面</title>
<link rel="stylesheet" type="text/css" href="/mobile/common/core/core_8488e02.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/dialog/dialog_09f6162.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/header/header_b51a32c.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/headertitle/headertitle_440e394.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/biglist/biglist_dba9b83.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/numchooser/numchooser_c64b34c.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/itembrief/itembrief_bc23208.css">
<link rel="stylesheet" type="text/css" href="/mobile/common/footerbutton/footerbutton_eea48c6.css">

<script type="text/javascript" src="/fishstrap/lib/fastclick.js"></script>
<script type="text/javascript" src="http://apps.bdimg.com/libs/underscore.js/1.7.0/underscore-min.js"></script>
<script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript" src="/fishstrap/core/global_0ffe271.js"></script>
<script type="text/javascript" src="/mobile/common/dialog/dialog_e661e90.js"></script>
<script type="text/javascript" src="/mobile/common/core/core_ced14df.js"></script>
<script type="text/javascript" src="/mobile/common/header/header_23de960.js"></script>
<script type="text/javascript" src="/mobile/common/headertitle/headertitle_9a8434f.js"></script>
<script type="text/javascript" src="/mobile/common/numchooser/numchooser_faad02f.js"></script>
<script type="text/javascript" src="/mobile/common/itembrief/itembrief_6ce8ed8.js"></script>
<script type="text/javascript" src="/mobile/common/biglist/biglist_32dcb01.js"></script>
<script type="text/javascript" src="/fishstrap/util/uedit_466b933.js"></script>
<script type="text/javascript" src="/mobile/common/footerbutton/footerbutton_7c867f1.js"></script>
<script type="text/javascript" src="/fishstrap/sdk/wxsdk_b078d6a.js"></script>

</head>
<body>
	<div id="body"></div>
	<script type="text/javascript">
		var $ = require('mobile/common/core/core.js');
		var dialog = require('mobile/common/dialog/dialog.js');
		var Header = require('mobile/common/header/header.js');
		var HeaderTitle = require('mobile/common/headertitle/headertitle.js');
		var BigList = require('mobile/common/biglist/biglist.js');
		var FooterButton = require('mobile/common/footerbutton/footerbutton.js');
		var WXSdk = require('fishstrap/sdk/wxsdk.js');
		var shopOrderId = $.location.getQueryArgv('shopOrderId');
		var orderStateIdToName = {0:'全部',1:'未支付',2:'待发货',3:'已发货'};
		var paymentIdToName = {1:'微信支付',2:'货到付款'};
		var shopOrder = {};
		function orderPay(shopOrderId,next){
			$.get('/deal/wxjspay',{shopOrderId:shopOrderId},function(data){
				if(data.code!=0){
					dialog.message(data.msg);
					return;
				}
				WXSdk.enableDebugMode();
				WXSdk.ready(function(){
					WXSdk.pay(data.data,{
						success:function(msg){
							next();
						},
						fail:function(msg){
							alert('用户取消支付');
						}
					});
				});
			});
		}
		function getShopOrder(next){
			$.get('/deal/getMyOrderDetail',{shopOrderId:shopOrderId},function(data){
				if( data.code != 0 ){
					dialog.message(data.msg);
					return;
				}
				shopOrder = data.data;
				next();
			})
		}
		function go(){
			var header = new Header({
				title:'订单详情',
				backLink:'deal.html',
				button:[]
			});
			var dealIdTitle = new HeaderTitle({
				tip:'订单编号：',
				text:shopOrder.shopOrderId
			});
			var dealStateTitle = new HeaderTitle({
				tip:'订单状态：',
				text:orderStateIdToName[shopOrder.state]
			});
			var dealPriceTitle = new HeaderTitle({
				tip:'订单金额：',
				text:'￥'+shopOrder.priceShow
			});
			var nameTitle = new HeaderTitle({
				tip:'收货人：',
				text:shopOrder.address.name
			});
			var phoneTitle = new HeaderTitle({
				tip:'手机号码：',
				text:shopOrder.address.phone
			});
			var provinceTitle = new HeaderTitle({
				tip:'省份：',
				text:shopOrder.address.province
			});
			var cityTitle = new HeaderTitle({
				tip:'城市：',
				text:shopOrder.address.city
			});
			var addressTitle = new HeaderTitle({
				tip:'地址：',
				text:shopOrder.address.address
			});
			var payTitle = new HeaderTitle({
				tip:'支付：',
				text:paymentIdToName[shopOrder.address.payment]
			});
			var biglist = new BigList(_.map(shopOrder.commodity,function(singleCommodity){
				return {
					link:$.url.buildQueryUrl('itemdetail.html',{shopOrderCommodityId:singleCommodity.shopOrderCommodityId}),
					image:singleCommodity.icon,
					title:singleCommodity.title,
					summary:singleCommodity.introduction,
					price:singleCommodity.priceShow,
					oldPrice:singleCommodity.oldPrice,
					buyQuantity:singleCommodity.quantity
				}
			}));
			var footerbutton = {};
			if( shopOrder.state == 1 ){
				footerbutton = new FooterButton([
					{
						name:'pay',
						text:'支付',
						click:function(){
							orderPay(shopOrder.shopOrderId,function(){
								dialog.message('支付成功！',function(){
									history.back();
								});
							});
						}
					}
				]);
			}else{
				footerbutton = new FooterButton([
					{
						name:'confirm',
						text:'确认',
						click:function(){
							history.back();
						}
					}
				]);
			}
			var pageHtml = header.el + 
				dealIdTitle.el + dealStateTitle.el + dealPriceTitle.el+

				biglist.el +
				 nameTitle.el + provinceTitle.el+cityTitle.el+addressTitle.el + phoneTitle.el + payTitle.el+
				footerbutton.el;
			$.page.setGrey();
			$.page.start(pageHtml);
		}
		getShopOrder(go);
	</script>
</body>
</html>